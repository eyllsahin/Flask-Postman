{% extends "admin_base.html" %}

{% block title %}Admin Dashboard - Fraude{% endblock %}

{% block content %}
<div class="container">
    <div class="admin-header">
        <div class="admin-title-section">
            <img src="{{ url_for('static', filename='img/fraudeLogo.svg') }}" alt="Fraude" class="fraude-logo">
            <h1 class="admin-title">Admin Dashboard</h1>
        </div>
        <button id="logoutBtn" class="magical-btn">Leave Realm</button>
    </div>

    <div class="stats-cards">
        <div class="stat-card">
            <h3>Total Users</h3>
            <div class="stat-number">{{ stats.total_users }}</div>
        </div>
        <div class="stat-card">
            <h3>Active Sessions</h3>
            <div class="stat-number">{{ stats.active_sessions }}</div>
        </div>
        <div class="stat-card">
            <h3>Total Messages</h3>
            <div class="stat-number">{{ stats.total_messages }}</div>
        </div>
    </div>

    <div class="user-section">
        <div class="user-overview-header">
            <h2>✧ User Activity Overview ✧</h2>
        </div>

        {% for user in users %}
        <div class="user-card">
            <div class="user-header">
                <button class="user-name-btn" data-user-id="{{ user.id }}">
                    <h3>{{ user.username }}</h3>
                </button>
                <span class="user-email">{{ user.email }}</span>
                <span class="user-id">ID: {{ user.id }}</span>
                <span class="join-date">Joined: {{ user.created_at }}</span>
            </div>
            
            <div class="sessions-list">
                <div class="sessions-header">
                    <h4>Chat Sessions ({{ user.sessions|length }}{% if user.sessions|length >= 20 %}+ sessions - showing recent 20{% else %} total{% endif %})</h4>
                    <button class="collapse-btn" onclick="toggleSessions(this)">
                        <span class="collapse-icon">▼</span>
                    </button>
                </div>
                <div class="sessions-content collapsed">
                    <div class="sessions-table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Session ID</th>
                                    <th>Title</th>
                                    <th>Created</th>
                                    <th>Status</th>
                                    <th>Message Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in user.sessions %}
                                <tr class="{{ 'inactive' if not session.is_active else '' }}">
                                    <td>{{ session.id }}</td>
                                    <td class="session-title">{{ session.title | e | truncate(50, true, '...') }}</td>
                                    <td>{{ session.created_at }}</td>
                                    <td>
                                        {% if session.is_active %}
                                        <span class="status active">Active</span>
                                        {% else %}
                                        <span class="status inactive">Deleted</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ session.message_count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const logoutBtn = document.getElementById('logoutBtn');
    
    async function performLogout() {
        try {
            await fetch("/logout", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${localStorage.getItem('token')}`,
                    "Content-Type": "application/json"
                }
            });
        } catch (err) {
            console.log("Logout request failed, but continuing with client-side cleanup");
        }
        
        localStorage.removeItem('token');
        sessionStorage.clear();
        
        document.cookie.split(";").forEach(function(c) { 
            document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
        });
        
        if ('caches' in window) {
            caches.keys().then(names => {
                names.forEach(name => {
                    caches.delete(name);
                });
            });
        }
        
        window.history.replaceState(null, null, "/login");
        window.location.replace('/login'); 
    }
    
    logoutBtn.addEventListener('click', performLogout);
});

function toggleSessions(button) {
    const sessionsContent = button.closest('.sessions-list').querySelector('.sessions-content');
    const icon = button.querySelector('.collapse-icon');
    
    if (sessionsContent.classList.contains('collapsed')) {
        sessionsContent.classList.remove('collapsed');
        icon.style.transform = 'rotate(0deg)';
        button.title = 'Collapse sessions';
    } else {
        sessionsContent.classList.add('collapsed');
        icon.style.transform = 'rotate(-90deg)';
        button.title = 'Expand sessions';
    }
}
</script>
{% endblock %}
